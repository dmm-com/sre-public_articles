# AWS Organizationsを活用し、アカウント運用を効率化する

おはようございます、こんにちは。インフラ本部SRE部の河村と申します。私の所属しているインフラ本部SRE部では、
グループを横断してシステムの信頼性を向上させる取り組みを行っておりますが、いわゆるCcoE(Cloud Center of Excellence)
としての活動も行っており、グループ内でのパブリッククラウドの利用推進や改善も担当しております。本日はAWS Organizationsを利用した
、マルチアカウント環境におけるアカウント管理の効率化について紹介します。

## DMMのAWSの利用状況 
DMMでは、約n個のサービスがAWSで稼働しております。各サービスはサービスごと（あるいは環境ごと）にAWSアカウントを持っており、
それぞれの担当エンジニアリングチームが開発や運用を行っております。技術選定やアーキテクチャなどは、各チームに委ねられており、
エンジニアにとっては自由度があり、好きに作れる良さがあります。一方、アカウント管理や運用の効率化のために必要な諸タスクも
それぞれのチームで実行する必要があり、 行うような処理をそれぞれのチームが別に実装している、という状況がありました。
サービスを担当するエンジニアリングチームは、サービスの開発・運用に集中するべきで、共通的な処理は各チームでそれぞれ実装するのではなく、
共通化してしまうことが望ましいです。
各サービスのエンジニアが手を動かすことなく、共通処理を設定、実行できるようにすることでそれを実現できるのではないか、と考えました。

## Solution
マルチアカウントの一元管理のためのソリューションとして、AWSではAWS Organizationsを提供しています。組織内のアカウントであれば、
各メンバーアカウントから、なんらかの情報抽出をしたりすることが容易に可能です。ここでは一例としてコストの情報をレポートする処理を実装します。
AWS Organizationsを利用している場合、以下のようなlambda functionで、組織内のアカウントのサービスごとのコストを取得することができます。

```python
    query = {
        'TimePeriod': {
            'Start': start_date.strftime('%Y-%m-%d'),
            'End': end_date.strftime('%Y-%m-%d')
        },
        'Granularity': 'DAILY',
        'Metrics': ['BlendedCost'],
        'GroupBy': [
            {
                'Type': 'DIMENSION',
                'Key': 'SERVICE'
            }
        ],
        'Filter': {
            'Dimensions': {
                'Key': 'LINKED_ACCOUNT',
                'Values': [account_id]
            }
        }
    }
```

これでコスト情報がとれるようになりましたが、アカウントごとに任意のSlack Channelなどに情報を通知するように設定してみます。
コードに触ったり、デプロイをすることなく、対象のアカウントの追加や通知先の設定を行えるようにしたいので、設定情報はコードに含まず、S3内のファイルで管理することにします。 例えば以下のようなファイルです。

```
[
  {
    "AccountId": "997942897203",
    "Description": "book本体ステージング",
    "ChannelIds": [
      "CR96Q1EJW"
    ],
    "Currency": "JPY",
    "Granularity": [
      "DAILY"
    ],
    "FilterTags": ""
  },
  ...(略
]
```

このファイルを読み込んで、コストの取得処理を行います。余談ですが、最近はこのような処理をさくっと作りたいとき、AWS step functionなどを使うのが便利です。
AWSの機能やlambda functionなどを組み合わせて、ワークフローを作ることができます。グラフィカルインターフェースでサクッと作ることができます。すごい時代ですね。
これをAmazon EventBridge スケジューラなどで定期実行すれば、定期的にコスト情報を取得することができます。

![スクリーンショット 2023-11-18 5.56.32.png](%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202023-11-18%205.56.32.png)

最後に、設定ファイルをgitやawsに馴染みのない社員も設定を編集できるように、Google Spreadsheetで管理ようにします。spreadsheetの内容をjson化して、S3に配置するようにします。
色々なやり方がありそうですが、AppScriptで実装すると以下のようなコードになると思います。

```
コードサンプル
```

実装後このような形で、コストの通知を受信できました。（実際にはSlack側のアプリ設定などが必要ですが、ここでは割愛します。）

![スクリーンショット 2023-11-18 6.27.08.png](%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202023-11-18%206.27.08.png)

## まとめ
さて、今回は、インフラ本部SRE部の仕事の紹介のひとつとして、AWS Organizationsを活用した共通処理の実装についてご紹介しました。
今回は例として、コスト情報を使いましたが、他の運用情報の通知にも同じような仕組みで一元管理しております。
AWSが提供している通知機能で十分な場合もありますが、マルチアカウント環境かつ、組織のニーズにあわせた処理を行いたい場合はこのような形で
カスタマイズすることも有益であろうと思います。

CcoE、またはSREアプローチで組織を横断的に改善していく仕事に興味がある方、DMMでは積極的に採用活動を行っておりますので、是非ご検討ください。

