# AWSの利用状況のSlack通知処理を共通化した話

おはようございます、こんにちは。ITインフラ本部SRE部のかわむらと申します。私の所属しているSRE部では、
Site Reliability Engineering の観点から、グループを横断してシステムの信頼性を向上させる取り組みを行っておりますが、いわゆるCcoE(Cloud Center of Excellence)
としての活動も行っており、グループ内のパブリッククラウドの利用推進や改善も担当しております。本日はAWS Organizationsを利用した 、アカウント管理の効率化施策について紹介します。

## DMMのAWSの利用状況 
DMMでは、多くのサービスがAWSで稼働しております。各サービスはサービスごと（あるいは環境ごと）にAWSアカウントを持っており、
それぞれのサービスを担当するエンジニアリングチームが開発や運用を行っております。技術選定やアーキテクチャなどは、各チームに委ねられており、
エンジニアにとっては自由度があり、好きに作れる良さがある一方、アカウント管理や運用の効率化のために必要な諸タスクもそれぞれのチームに委ねられており、 同じような処理をそれぞれのチームが個別実装している、という状況がありました。

サービスを担当するエンジニアリングチームは、サービスの開発・運用に集中するべきで、共通化できる処理は共通化してしまうことのが望ましいです。 そこで、AWS Organizationsを活用して、ニーズの高い通知処理を共通化して実装することにしました。

## 処理の実装
AWSでは複数のAWSアカウントを組織単位で管理するためのサービスとして、AWS Organizationsというサービスが用意されています。組織内のアカウントをグループ化し、組織全体でのポリシーの適用や、組織全体でのリソースの一元管理を行うことができます。
ここでは例としてAWSの利用料金通知の実装を紹介します。システムコストの通知はサービスの運用において重要な情報であり、共通化のニーズが非常に高いです。

アカウントごとに、通知内容をカスタムできるようにしたいので、設定ファイルにそのような情報をもたせ、それを元に通知処理を行うことにします。
設定ファイルに保存されたアカウント情報等を元に、コスト情報を並列処理で取得し、通知する処理を実装します。このような処理の実装はいろいろな手段があるとおもいますが、AWS Step FunctionsとLambdaを使うと、手軽にWorkflowを実装することができます。Concurrencyの設定もできますので、通知アカウントが大量になっても対応可能です。

設定ファイルは以下のようなイメージです。通知内容をアカウントごとにカスタムできるようにパラメータを用意します。設定ファイルは事業側でコードのデプロイなしに更新可能な仕組みを用意するのが良いと思います。

```
[
  {
    "AccountId": "___your_account_id___",
    "Description": "hogehoge service staging env",
    "ChannelIds": [
      "CR96Q1EJW"
    ],
    "Currency": "JPY",
    "Granularity": [
      "DAILY"
    ],
    "CostTags": ""
  },
  ...(略
]
```

Step Functionsで作るWorkflowは以下のようになります。
![screenshot_workflow.png](screenshot_workflow.png)

## コストの取得
AWSのコスト情報は、AWS Cost Explorer APIを使って取得することができます。AWS Organizationsのメンバーアカウントからデータを取得するには LINKED_ACCOUNTというパラメータにAccount Idを
取得するように実装します。Lambdaコードは以下のようになります。

```
    query = {
        'TimePeriod': {
            'Start': start_date.strftime('%Y-%m-%d'),
            'End': end_date.strftime('%Y-%m-%d')
        },
        'Granularity': 'DAILY',
        'Metrics': ['BlendedCost'],
        'GroupBy': [
            {
                'Type': 'DIMENSION',
                'Key': 'SERVICE'
            }
        ],
        'Filter': {
            'Dimensions': {
                'Key': 'LINKED_ACCOUNT',
                'Values': [account_id]
            }
        }
    }
```

できたStep FunctionをAmazon EventBridge スケジューラなどで定期実行すれば、、、はい、このような形で、コストの通知を受信することができました。（実際にはSlack側のアプリ設定などが必要ですが、ここでは割愛します。）
![screenshot_cost_report.png](screenshot_cost_report.png)

## まとめ
さて、今回は、インフラ本部SRE部のCcoE的な活動のひとつとして、AWS Organizationsを活用した共通処理の実装についてご紹介しました。 例として、コスト情報を使いましたが、他の運用情報の通知にも同じような仕組みで一元管理しております。
AWSが提供している通知機能で十分な場合もありますが、通知内容はカスタマイズしつつ、処理の実装・実行は共通化すると、効率よく事業や組織のニーズに応えられるのではないでしょうか。

CcoE、またはSRE的なアプローチでDMMのサービスを横断的に改善していく仕事に興味がある方、現在積極的に採用活動を行っておりますので、是非ご検討ください。

